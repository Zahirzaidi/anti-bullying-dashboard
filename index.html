<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Anti-Bullying Dashboard</title>

<style>
body{
  font-family: Arial;
  background:#f2f2f2;
  text-align:center;
}

#loginBox{
  width:300px;
  margin:150px auto;
  padding:20px;
  background:white;
  border-radius:10px;
  box-shadow:0 0 10px gray;
}

input{
  width:90%;
  padding:10px;
  margin:8px;
}

button{
  padding:8px 15px;
  margin:3px;
  cursor:pointer;
}

#dashboard{
  display:none;
}

h1{
  background:#1e88e5;
  color:white;
  padding:15px;
}

.alert{
  background:red;
  color:white;
  animation:blink 1s infinite;
}

@keyframes blink{
  0%{opacity:1;}
  50%{opacity:0.4;}
  100%{opacity:1;}
}

.normal{
  background:green;
  color:white;
}

li{
  list-style:none;
  margin:6px auto;
  padding:10px;
  width:320px;
  border-radius:6px;
}

#stopBtn{
  background:red;
  color:white;
  display:none;
}
</style>
</head>

<body>

<!-- LOGIN -->
<div id="loginBox">
  <h2>Admin Login</h2>
  <input id="username" placeholder="Username">
  <input id="password" type="password" placeholder="Password">
  <button onclick="login()">LOGIN</button>
</div>

<!-- DASHBOARD -->
<div id="dashboard">

<h1>Anti-Bullying Monitor</h1>

<h3 id="counter">Total Alerts: 0</h3>

<button onclick="activateSystem()">ACTIVATE SYSTEM</button><br><br>

<button id="stopBtn" onclick="stopAlarm()">STOP ALARM</button>

<audio id="alarmSound" loop>
  <source src="siren.mp3">
</audio>

<h2>Room Status</h2>

<button onclick="setFilter('ALL')">ALL</button>
<button onclick="setFilter('JT')">JATI</button>
<button onclick="setFilter('MR')">MERANTI</button>

<ul id="roomList"></ul>

<h2>Alert History</h2>
<button onclick="clearHistory()">CLEAR HISTORY</button>
<ul id="historyList"></ul>

</div>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase.js"></script>

<script>

// LOGIN
function login(){
  var u=document.getElementById("username").value;
  var p=document.getElementById("password").value;

  if(u=="admin" && p=="admin123"){
    document.getElementById("loginBox").style.display="none";
    document.getElementById("dashboard").style.display="block";
    refreshRooms();
  }else{
    alert("Wrong Login!");
  }
}

// SYSTEM
let systemActive=false;
let lastStatus={};
let currentFilter="ALL";

function activateSystem(){
  systemActive=true;
  alert("System Activated");
}

function stopAlarm(){
  alarmSound.pause();
  alarmSound.currentTime=0;
  document.getElementById("stopBtn").style.display="none";
}

function clearHistory(){
  database.ref("history").remove();
  alert("History Cleared");
}

function setFilter(type){
  currentFilter=type;
  refreshRooms();
}

// FIREBASE
var firebaseConfig = {
  apiKey: "AIzaSyAMstKG96DUKOPbJQZKKssWtHbc4iLtccI",
  authDomain: "antibullyingsystem-95305.firebaseapp.com",
  databaseURL: "https://antibullyingsystem-95305-default-rtdb.firebaseio.com",
  projectId: "antibullyingsystem-95305",
  storageBucket: "antibullyingsystem-95305.firebasestorage.app",
  messagingSenderId: "808658741708",
  appId: "1:808658741708:web:fa50c6a83341e26bc6d569"
};

firebase.initializeApp(firebaseConfig);

var database=firebase.database();
var roomList=document.getElementById("roomList");
var historyList=document.getElementById("historyList");
var alarmSound=document.getElementById("alarmSound");

// REFRESH ROOMS (FILTER WORKING)
function refreshRooms(){

database.ref("rooms").once("value",function(snapshot){

roomList.innerHTML="";

snapshot.forEach(function(child){

var room=child.key;
var status=child.val().status;

if(currentFilter!="ALL"){
  if(!room.startsWith(currentFilter)){
    return;
  }
}

var li=document.createElement("li");
li.innerText=room+" - "+status;

if(status=="ALERT"){
  li.className="alert";

  if(systemActive){
    alarmSound.play();
    document.getElementById("stopBtn").style.display="inline";
  }

  if(lastStatus[room]!="ALERT"){
    var now=new Date();
    database.ref("history").push({
      room:room,
      status:"ALERT",
      time:now.toLocaleTimeString(),
      date:now.toLocaleDateString()
    });
  }

}else{
  li.className="normal";
}

lastStatus[room]=status;
roomList.appendChild(li);

});

});

}

// AUTO UPDATE ROOM STATUS
database.ref("rooms").on("value",function(){
  refreshRooms();
});

// HISTORY + COUNTER
database.ref("history").on("value",function(snapshot){

historyList.innerHTML="";
document.getElementById("counter").innerText =
"Total Alerts: " + snapshot.numChildren();

snapshot.forEach(function(child){
var d=child.val();
var li=document.createElement("li");
li.innerText=d.room+" | "+d.status+" | "+d.time+" | "+d.date;
historyList.appendChild(li);
});

});

</script>

</body>
</html>
