<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Anti-Bullying Smart System</title>

<!-- PDF LIBRARY -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
body{font-family:Arial;background:#f2f2f2;text-align:center;}
#loginBox{width:300px;margin:150px auto;padding:20px;background:#fff;border-radius:10px;}
input{width:90%;padding:10px;margin:8px;}
button{padding:8px 15px;margin:5px;}
#dashboard{display:none;}
.alert{background:red;color:white;}
.normal{background:green;color:white;}
li{list-style:none;margin:5px;padding:10px;border-radius:5px;}
</style>
</head>

<body>

<div id="loginBox">
<h2>Login</h2>
<input id="username" placeholder="Username">
<input id="password" type="password" placeholder="Password">
<button onclick="login()">LOGIN</button>
</div>

<div id="dashboard">

<h2 id="welcome"></h2>

<button onclick="emergencyAlert()">ðŸš¨ EMERGENCY ALERT</button><br><br>

<button id="clearBtn" onclick="clearHistory()">CLEAR HISTORY</button>
<button onclick="exportPDF()">EXPORT DAILY REPORT</button>

<h3>Room Status</h3>
<ul id="roomList"></ul>

<h3>History</h3>
<ul id="historyList"></ul>

</div>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase.js"></script>

<script>

// FIREBASE
firebase.initializeApp({
 apiKey:"AIzaSyAMstKG96DUKOPbJQZKKssWtHbc4iLtccI",
 authDomain:"antibullyingsystem-95305.firebaseapp.com",
 databaseURL:"https://antibullyingsystem-95305-default-rtdb.firebaseio.com",
 projectId:"antibullyingsystem-95305"
});

let db=firebase.database();
let currentUser="", currentRole="";

// LOGIN
function login(){
 let u=username.value;
 let p=password.value;

 db.ref("users/"+u).once("value",snap=>{
   if(!snap.exists()){alert("User not found");return;}
   let d=snap.val();
   if(d.password==p){
     currentUser=u;
     currentRole=d.role;
     loginBox.style.display="none";
     dashboard.style.display="block";
     welcome.innerText="Welcome "+u+" ("+currentRole+")";

     if(currentRole!="admin") clearBtn.style.display="none";

     dailyResetCheck();
     loadRooms();
     loadHistory();
   }else alert("Wrong password");
 });
}

// ROOMS
function loadRooms(){
 db.ref("rooms").on("value",snap=>{
  roomList.innerHTML="";
  snap.forEach(c=>{
    let li=document.createElement("li");
    li.innerText=c.key+" - "+c.val().status;
    li.className=c.val().status=="ALERT"?"alert":"normal";
    roomList.appendChild(li);
  });
 });
}

// HISTORY
function loadHistory(){
 db.ref("history").on("value",snap=>{
  historyList.innerHTML="";
  snap.forEach(c=>{
    let d=c.val();
    let li=document.createElement("li");
    li.innerText=d.type+" | "+d.triggeredBy+" ("+d.role+") | "+d.time;
    historyList.appendChild(li);
  });
 });
}

// EMERGENCY
function emergencyAlert(){
 let now=new Date();
 db.ref("history").push({
  type:"EMERGENCY",
  triggeredBy:currentUser,
  role:currentRole,
  time:now.toLocaleTimeString(),
  date:now.toLocaleDateString()
 });
 alert("Emergency Triggered!");
}

// CLEAR HISTORY (ADMIN ONLY)
function clearHistory(){
 db.ref("history").remove();
 alert("History Cleared");
}

// DAILY RESET 8AM
function dailyResetCheck(){
 let today=new Date().toLocaleDateString();
 let hour=new Date().getHours();

 db.ref("system/lastReset").once("value",snap=>{
   let last=snap.val();
   if(last!=today && hour>=8){
     db.ref("history").remove();
     db.ref("system/lastReset").set(today);
   }
 });
}

// EXPORT PDF
function exportPDF(){
 const {jsPDF}=window.jspdf;
 let doc=new jsPDF();
 let y=10;
 doc.text("Daily Anti-Bullying Report",10,y);
 y+=10;

 db.ref("history").once("value",snap=>{
   snap.forEach(c=>{
     let d=c.val();
     doc.text(d.type+" | "+d.triggeredBy+" | "+d.time,10,y);
     y+=10;
   });
   doc.save("daily_report.pdf");
 });
}

</script>

</body>
</html>
